<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accio - Object Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .object { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .object img { max-width: 200px; max-height: 200px; }
        form { margin: 20px 0; }
        input, select, textarea { display: block; margin: 5px 0; width: 100%; }
        button { margin: 5px; }
    </style>
</head>
<body>
    <h1>Accio</h1>
    <div id="auth">
        <button id="google-signin">Sign in with Google</button>
    </div>
    <div id="user-info" style="display: none;">
        <p>Welcome, <span id="user-name"></span>!</p>
        <button id="signout">Sign out</button>
    </div>

    <div id="objects-section" style="display: none;">
        <h2>Objects</h2>
        <button id="new-object-btn">New Object</button>
        <div id="objects-list"></div>

        <div id="object-form" style="display: none;">
            <h3 id="form-title">Create Object</h3>
            <form id="object-form-el">
                <input type="hidden" id="object-id">
                <label>Name: <input type="text" id="name" required></label>
                <label>Description: <textarea id="description"></textarea></label>
                <label>Type:
                    <select id="type">
                        <option value="site">Site</option>
                        <option value="area">Area</option>
                        <option value="container">Container</option>
                        <option value="item">Item</option>
                    </select>
                </label>
                <div id="current-location-label">
                    <label><span id="current-location-text">Current Location:</span>
                        <select id="current_location_id">
                            <option value="">None</option>
                        </select>
                    </label>
                </div>
                <div id="assigned-location-label">
                    <label><span id="assigned-location-text">Assigned Location:</span>
                        <select id="assigned_location_id">
                            <option value="">None</option>
                        </select>
                    </label>
                </div>
                <button type="submit">Save</button>
                <button type="button" id="cancel-btn">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://vgkbzcikpljsfomfqgpp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZna2J6Y2lrcGxqc2ZvbWZxZ3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMjQ1ODksImV4cCI6MjA3NjkwMDU4OX0.bojb9pj1XtHgjIw9WetqPltKhUDzC56V_V95zqze94A';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const googleSigninBtn = document.getElementById('google-signin');
        const signoutBtn = document.getElementById('signout');
        const authDiv = document.getElementById('auth');
        const userInfoDiv = document.getElementById('user-info');
        const userNameSpan = document.getElementById('user-name');
        const objectsSection = document.getElementById('objects-section');
        const objectsList = document.getElementById('objects-list');
        const objectForm = document.getElementById('object-form');
        const formTitle = document.getElementById('form-title');
        const objectFormEl = document.getElementById('object-form-el');
        const newObjectBtn = document.getElementById('new-object-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        let currentUser = null;

        // Check if user is already signed in
        supabase.auth.getUser().then(({ data: { user } }) => {
            if (user) {
                currentUser = user;
                showUserInfo(user);
                loadObjects();
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google'
            });
            if (error) {
                console.error('Error signing in:', error);
                alert('Error signing in: ' + error.message);
            }
        });

        signoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error);
            } else {
                currentUser = null;
                showAuth();
            }
        });

        newObjectBtn.addEventListener('click', () => {
            showForm();
        });

        cancelBtn.addEventListener('click', () => {
            hideForm();
        });

        document.getElementById('type').addEventListener('change', updateLocationFieldsBasedOnType);

        objectFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('object-id').value;
            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const type = document.getElementById('type').value;
            let current_location_id = document.getElementById('current_location_id').value || null;
            let assigned_location_id = document.getElementById('assigned_location_id').value || null;

            if (type === 'area') {
                assigned_location_id = current_location_id;
            }

            const validationError = validateObjectLocations(type, current_location_id, assigned_location_id);
            if (validationError) {
                alert('Validation error: ' + validationError);
                return;
            }

            if (id) {
                const { error } = await supabase
                    .from('objects')
                    .update({ name, description, type, current_location_id, assigned_location_id })
                    .eq('id', id);
                if (error) alert('Error updating: ' + error.message);
            } else {
                const { error } = await supabase
                    .from('objects')
                    .insert({ name, description, type, current_location_id, assigned_location_id, user_id: currentUser.id });
                if (error) alert('Error creating: ' + error.message);
            }
            hideForm();
            loadObjects();
        });

        function validateObjectLocations(type, currentLocId, assignedLocId) {
            if (type === 'site') {
                if (currentLocId || assignedLocId) {
                    return 'Sites cannot have locations';
                }
            } else if (type === 'area') {
                if (!currentLocId || !assignedLocId) {
                    return 'Areas must have both locations set';
                }
                if (currentLocId !== assignedLocId) {
                    return 'Area locations must match';
                }
                const parent = window.objectsData.find(o => o.id == currentLocId);
                if (parent && parent.type !== 'site' && parent.type !== 'area') {
                    return 'Area can only reference a site or area';
                }
            } else if (type === 'container' || type === 'item') {
                if (!currentLocId) {
                    return type + ' must have a current location';
                }
                const currentParent = window.objectsData.find(o => o.id == currentLocId);
                if (currentParent && !['site', 'area', 'container'].includes(currentParent.type)) {
                    return type + ' can only reference a site, area, or container';
                }
                if (assignedLocId) {
                    const assignedParent = window.objectsData.find(o => o.id == assignedLocId);
                    if (assignedParent && !['site', 'area', 'container'].includes(assignedParent.type)) {
                        return type + ' can only reference a site, area, or container';
                    }
                }
            }
            return null;
        }

        function showUserInfo(user) {
            authDiv.style.display = 'none';
            userInfoDiv.style.display = 'block';
            objectsSection.style.display = 'block';
            userNameSpan.textContent = user.user_metadata.full_name || user.email;
        }

        function showAuth() {
            authDiv.style.display = 'block';
            userInfoDiv.style.display = 'none';
            objectsSection.style.display = 'none';
        }

        function showForm(object = null) {
            objectForm.style.display = 'block';
            loadLocations();
            if (object) {
                formTitle.textContent = 'Edit Object';
                document.getElementById('object-id').value = object.id;
                document.getElementById('name').value = object.name;
                document.getElementById('description').value = object.description;
                document.getElementById('type').value = object.type;
                document.getElementById('current_location_id').value = object.current_location_id || '';
                document.getElementById('assigned_location_id').value = object.assigned_location_id || '';
            } else {
                formTitle.textContent = 'Create Object';
                objectFormEl.reset();
                document.getElementById('object-id').value = '';
            }
            updateLocationFieldsBasedOnType();
        }

        function hideForm() {
            objectForm.style.display = 'none';
        }

        function updateLocationFieldsBasedOnType() {
            const type = document.getElementById('type').value;
            const currentLocLabel = document.getElementById('current-location-label');
            const assignedLocLabel = document.getElementById('assigned-location-label');
            const currentLocText = document.getElementById('current-location-text');
            const assignedLocText = document.getElementById('assigned-location-text');
            const currentLocSelect = document.getElementById('current_location_id');
            const assignedLocSelect = document.getElementById('assigned_location_id');

            if (type === 'site') {
                currentLocLabel.style.display = 'none';
                assignedLocLabel.style.display = 'none';
                currentLocSelect.value = '';
                assignedLocSelect.value = '';
                currentLocSelect.required = false;
                assignedLocSelect.required = false;
            } else if (type === 'area') {
                currentLocLabel.style.display = 'block';
                assignedLocLabel.style.display = 'none';
                currentLocText.textContent = 'Location:';
                
                filterLocationsForArea();
                
                currentLocSelect.required = true;
                assignedLocSelect.required = false;
            } else if (type === 'container' || type === 'item') {
                currentLocLabel.style.display = 'block';
                assignedLocLabel.style.display = 'block';
                currentLocText.textContent = 'Current Location:';
                assignedLocText.textContent = 'Assigned Location:';
                
                filterLocationsForContainerItem();
                
                currentLocSelect.required = true;
                assignedLocSelect.required = false;
            }
        }

        function filterLocationsForArea() {
            const sitesAndAreas = window.objectsData.filter(obj => 
                obj.type === 'site' || obj.type === 'area'
            );
            
            const currentSelect = document.getElementById('current_location_id');
            const assignedSelect = document.getElementById('assigned_location_id');
            
            currentSelect.innerHTML = '';
            assignedSelect.innerHTML = '';
            
            sitesAndAreas.forEach(obj => {
                const option = `<option value="${obj.id}">${obj.name} (${obj.type})</option>`;
                currentSelect.innerHTML += option;
                assignedSelect.innerHTML += option;
            });
        }

        function filterLocationsForContainerItem() {
            const validParents = window.objectsData.filter(obj => 
                obj.type === 'site' || obj.type === 'area' || obj.type === 'container'
            );
            
            const currentSelect = document.getElementById('current_location_id');
            const assignedSelect = document.getElementById('assigned_location_id');
            
            currentSelect.innerHTML = '';
            assignedSelect.innerHTML = '<option value="">None</option>';
            
            validParents.forEach(obj => {
                const option = `<option value="${obj.id}">${obj.name} (${obj.type})</option>`;
                currentSelect.innerHTML += option;
                assignedSelect.innerHTML += option;
            });
        }

        async function loadObjects() {
            const { data, error } = await supabase
                .from('objects')
                .select(`
                    *,
                    object_images(*)
                `)
                .order('created_at', { ascending: false });
            if (error) {
                alert('Error loading objects: ' + error.message);
                return;
            }
            window.objectsData = data;
            renderObjects(data);
        }

        async function loadLocations() {
            const { data, error } = await supabase
                .from('objects')
                .select('id, name')
                .order('name');
            if (error) {
                console.error('Error loading locations:', error);
                return;
            }
            const currentSelect = document.getElementById('current_location_id');
            const assignedSelect = document.getElementById('assigned_location_id');
            currentSelect.innerHTML = '<option value="">None</option>';
            assignedSelect.innerHTML = '<option value="">None</option>';
            data.forEach(obj => {
                const option = `<option value="${obj.id}">${obj.name}</option>`;
                currentSelect.innerHTML += option;
                assignedSelect.innerHTML += option;
            });
        }

        function renderObjects(objects) {
            objectsList.innerHTML = '';
            objects.forEach(obj => {
                const currentLocationName = obj.current_location_id 
                    ? window.objectsData.find(o => o.id === obj.current_location_id)?.name || 'Unknown'
                    : 'None';
                const assignedLocationName = obj.assigned_location_id
                    ? window.objectsData.find(o => o.id === obj.assigned_location_id)?.name || 'Unknown'
                    : 'None';
                
                const div = document.createElement('div');
                div.className = 'object';
                div.innerHTML = `
                    <h3>${obj.name}</h3>
                    <p>${obj.description}</p>
                    <p>Type: ${obj.type}</p>
                    <p>Current Location: ${currentLocationName}</p>
                    <p>Assigned Location: ${assignedLocationName}</p>
                    <div id="images-${obj.id}"></div>
                    <input type="file" id="file-${obj.id}" multiple accept="image/*">
                    <button onclick="uploadImage(${obj.id})">Upload Image</button>
                    <button onclick="editObject(${obj.id})">Edit</button>
                    <button onclick="deleteObject(${obj.id})">Delete</button>
                `;
                const imagesDiv = div.querySelector(`#images-${obj.id}`);
                obj.object_images.forEach(img => {
                    const imgEl = document.createElement('img');
                    imgEl.src = img.image_url;
                    imagesDiv.appendChild(imgEl);
                });
                objectsList.appendChild(div);
            });
        }

        async function uploadImage(objectId) {
            const fileInput = document.getElementById(`file-${objectId}`);
            const files = fileInput.files;
            if (!files.length) return;

            for (let file of files) {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `objects/${objectId}/${fileName}`;

                const { error: uploadError } = await supabase.storage
                    .from('object-images')
                    .upload(filePath, file);

                if (uploadError) {
                    alert('Error uploading image: ' + uploadError.message);
                    continue;
                }

                const { data } = supabase.storage
                    .from('object-images')
                    .getPublicUrl(filePath);

                const { error: insertError } = await supabase
                    .from('object_images')
                    .insert({ object_id: objectId, image_url: data.publicUrl });

                if (insertError) {
                    alert('Error saving image: ' + insertError.message);
                }
            }
            loadObjects();
        }

        function editObject(id) {
            // Find the object data from the loaded data
            const obj = window.objectsData.find(o => o.id == id);
            if (obj) {
                showForm(obj);
            }
        }

        async function deleteObject(id) {
            if (confirm('Are you sure?')) {
                const { error } = await supabase
                    .from('objects')
                    .delete()
                    .eq('id', id);
                if (error) alert('Error deleting: ' + error.message);
                else loadObjects();
            }
        }

        // Make functions global for onclick
        window.uploadImage = uploadImage;
        window.editObject = editObject;
        window.deleteObject = deleteObject;
    </script>
</body>
</html>